name: Deploy to EC2 with Docker
on:
  push:
    branches: [pedro-henrique-a-silva-bankme-2024]
jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the files
        uses: actions/checkout@v3

      - name: Instala o node
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Instala as dependáº½ncias do backend
        run: npm run install:back

      - name: Roda os testes do backend
        run: npm run test:back
     
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@ec2-3-16-207-167.us-east-2.compute.amazonaws.com "cd ~/apps && echo 'SSH is working' >> consegui.txt"

      - name: Transferindo arquivos para EC2
        run: |
          scp -r . ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:/home/${{ secrets.AWS_EC2_USER }}/app

      # - name: Deploy do amazon
      #   run: |
      #     echo "${{ secrets.AWS_EC2_KEY }}" > private_key && chmod 600 private_key
      #     ssh -o StrictHostKeyChecking=no -i private_key ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} '
      #       cd ~/apps && touch consegui.txt'